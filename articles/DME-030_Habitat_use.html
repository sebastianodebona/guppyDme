<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habitat use • guppyDme</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Habitat use">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">guppyDme</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Analyses

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/DME-000_Tidy_data.html">Tidy the Data</a>
    </li>
    <li>
      <a href="../articles/DME-011_Measurement_consistency.html">Measurement Consistency</a>
    </li>
    <li>
      <a href="../articles/DME-010_Habitat_characteristics.html">Habitat Characteristics</a>
    </li>
    <li>
      <a href="../articles/DME-015_Habitat_area.html">Habitat Area</a>
    </li>
    <li>
      <a href="../articles/DME-016_Dispersal_and_habitat_shift.html">Dispersal and Habitat shift</a>
    </li>
    <li>
      <a href="../articles/DME-020_Density_dependence.html">Density Dependence</a>
    </li>
    <li>
      <a href="../articles/DME-030_Habitat_use.html">Habitat Use</a>
    </li>
    <li>
      <a href="../articles/DME-035_DD_habitat_use.html">Density-Dependent Habitat Use</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sebastianodebona/guppyDme" class="external-link">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Habitat use</h1>
                        <h4 data-toc-skip class="author">Seba De
Bona</h4>
            
      

      <div class="hidden name"><code>DME-030_Habitat_use.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview-and-setup">Overview and Setup<a class="anchor" aria-label="anchor" href="#overview-and-setup"></a>
</h2>
<p>Here we will use the benthic area calculated <a href="DME-015_Habitat_use.html">here</a> to create predictive models to
assign an individual to the different habitats (with associated
probabilities) based on its size, sex and habitat availability.</p>
<p>We will fit a <a href="https://en.wikipedia.org/wiki/Discrete_choice" class="external-link">Discrete Choice
Model</a> on the capture data alone to calculate parameters defining the
probability to choose a habitat type based on size and sex, and weighed
by the habitat avilability. The model will be fitted using the package
<a href="https://cran.r-project.org/web/packages/mlogit/index.html" class="external-link">mlogit</a>.</p>
<p>Discrete Choice Models are used in econometrics to analyse, describe
and predict individual choices among a finite set of discrete
alternatives, based on a series of covariates that can be attributes to
the individual or to the alternatives. For example, we can analyse and
predict the preferred mean of transport by an individual, based on age
and income (individual attributes), between train, bus and car each of
which is associated with a certain cost, travel time and comfort
(alternative attributes). Moreover, we can include a third category of
covariates. The choice can be repeated several times, and each time the
season or weather might be different (choice situation attributes) and
affect the decision.</p>
<p>We will then use the parameters estimated by the model to calculate
the simulated habitat occupancy for each pool during the recapture,
based on the individuals that were recaptured, their size and sex.
Comparing this simulated occupancy with the real occupancy we will
detect an effect of density manipulation on habitat use.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># loading required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.5</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.1</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.5.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.1</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.4     </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span> masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>    masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'magrittr'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The following object is masked from 'package:purrr':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     set_names</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The following object is masked from 'package:tidyr':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     extract</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">nnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=mlogit" class="external-link">mlogit</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: dfidx</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dfidx'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this package requires the package guppyDme to be installed. If the user wishes not to install the package, please comment out the "library(guppyDme)" line and run instead the lines commented out below</span></span>
<span></span>
<span><span class="co">#### If you have the guppyDme package installed</span></span>
<span><span class="co"># loading package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sebastianodebona.github.io/guppyDme/">guppyDme</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # If you do NOT wish to install the guppyDme package, please uncomment and run the following two lines of code, adding the package functions to the Global Environment and loading the data</span></span>
<span><span class="co"># source(file.path(here::here(), "R", "package_functions.R"))</span></span>
<span><span class="co"># load(file.path(here::here(), "data", "DMEdata.rda"))</span></span>
<span></span>
<span><span class="co"># loading data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">DMEdata</span></span>
<span><span class="va">pool_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"vignettes"</span>, <span class="st">"DME_pool_composition.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">treatment_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"vignettes"</span>, <span class="st">"DME_density_factor_in_treatments.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># I am creating an additional column in the dataset, redefining sex_stage classes</span></span>
<span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex_stage <span class="op">=</span> <span class="fu">score_sexst</span><span class="op">(</span><span class="va">.</span>, f_threshold <span class="op">=</span> <span class="fl">14</span>, f_unit <span class="op">=</span> <span class="st">"SL"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There were 2 warnings in `mutate()`.</span></span>
<span><span class="co">## The first warning was:</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> In argument: `sex_stage = score_sexst(., f_threshold = 14, f_unit = "SL")`.</span></span>
<span><span class="co">## Caused by warning in `ifelse()`:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> NAs introduced by coercion</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Run `dplyr::last_dplyr_warnings()` to see the 1 remaining warning.</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="data-management">Data management<a class="anchor" aria-label="anchor" href="#data-management"></a>
</h2>
<p>To determine the structure of the data to be analysed I am using the
approach detailed in this <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/c2.formula.data.html" class="external-link">vignette</a>.</p>
<p>Before proceeding, DCMs allow to fit three separate kind of
covariate, defined by the scale at which they vary:</p>
<ul>
<li>individual-specific covariates (I)</li>
<li>alternative-specific covariates (A) or</li>
<li>choice situation specific covariates (C).</li>
</ul>
<p>In our case we will include size (I), sex (I) and the benthic area
associated with each habitat (A). There are also other variables we
could be including, and might, in the future:</p>
<ul>
<li>I: condition</li>
<li>A: mean and variance of water velocity, mean and variance of depth,
most represented substrate</li>
<li>C: density, size structure, total benthic area, n. of
alternatives</li>
</ul>
<p>For now we’ll just stick to the simplest model, and fitted to the
capture data only. Here using <strong>relative</strong> benthic area
measures for the different habitats.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># adding pool composition information to the data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">pool_comp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>recap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cap_recap</span> <span class="op">==</span> <span class="st">"cap"</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">recap</span>, <span class="va">streamID</span>, <span class="va">patchID</span>,</span>
<span>         A <span class="op">=</span> <span class="va">relA</span>, B <span class="op">=</span> <span class="va">relB</span>, C <span class="op">=</span> <span class="va">relC</span>, D <span class="op">=</span> <span class="va">relD</span>, E <span class="op">=</span> <span class="va">relE</span>, tot_ba <span class="op">=</span> <span class="va">tot</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">.</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding missing grouping variables: `cap_recap`</span></span>
<span><span class="co">## Joining with `by = join_by(streamID, recap, patchID)`</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># trimming only the needed data</span></span>
<span><span class="co"># We are here only including first capture, excluding Taylor mouth, and those datapoints where</span></span>
<span><span class="co"># habitat is not defined</span></span>
<span><span class="co"># We are also adding a unique ID column, to cope with repeated cohort marks later</span></span>
<span><span class="va">hab_sel</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">recap</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">streamID</span> <span class="op">!=</span> <span class="st">"TM"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">habitat</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">markID</span>, <span class="va">SL</span>, <span class="va">sex_stage</span>, <span class="va">habitat</span>,</span>
<span>         <span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html" class="external-link">add_column</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hab_sel</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">##   markID SL    sex_stage habitat     A     B     C     D     E    id</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> 5B6O   21.29 F         D       0.159 0.279 0.434 0.129     0     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 6W7K   20.62 F         D       0.159 0.279 0.434 0.129     0     2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> 6G7K   17.38 F         D       0.159 0.279 0.434 0.129     0     3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> 4G8K   17.64 M         D       0.159 0.279 0.434 0.129     0     4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> 4P6P   19.01 F         D       0.159 0.279 0.434 0.129     0     5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> 3R4K   15.72 F         D       0.159 0.279 0.434 0.129     0     6</span></span></code></pre>
<p>We need to transform the data so that it would fit the long format
described <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/c2.formula.data.html" class="external-link">here</a>.
This allows the choice set to vary between choice events (meaning it
will allow us to remove from a set of alternatives habitats that are not
present in a given pool).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reshaping it as a long format</span></span>
<span><span class="va">hab_sel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span>, key <span class="op">=</span> <span class="st">"alt"</span>, value <span class="op">=</span> <span class="st">"ba"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># just to better visualise it...</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># creating the choice column</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>choice <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="va">alt</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">markID</span>, <span class="va">alt</span>, <span class="va">choice</span>, <span class="va">SL</span>, <span class="va">sex_stage</span>, <span class="va">ba</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ba</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hab_sel</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">##      id markID alt   choice SL    sex_stage    ba</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1 5B6O   A          0 21.29 F         0.159</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     1 5B6O   B          0 21.29 F         0.279</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     1 5B6O   C          0 21.29 F         0.434</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>     1 5B6O   D          1 21.29 F         0.129</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>     2 6W7K   A          0 20.62 F         0.159</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>     2 6W7K   B          0 20.62 F         0.279</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We need to make sure that every individuals has a decision assigned.</span></span>
<span><span class="co"># If an individual was found in a habitat that is scored as having benthic area (ba) = 0,</span></span>
<span><span class="co"># such instance would be a mistake, and should be fixed.</span></span>
<span><span class="va">N_ROWS</span> <span class="op">&lt;-</span> <span class="va">hab_sel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">markID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>didPick <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">choice</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">didPick</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `summarise()` has grouped output by 'id'. You can override using the `.groups`</span></span>
<span><span class="co">## argument.</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">N_ROWS</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># all looks good!</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="building-the-predictive-model">Building the predictive model<a class="anchor" aria-label="anchor" href="#building-the-predictive-model"></a>
</h2>
<p>To build the model, I am using as guidelines two separate vignettes:
<a href="https://cran.r-project.org/web/packages/mlogit/vignettes/c2.formula.data.html" class="external-link">vignette
1</a> | <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/c3.rum.html" class="external-link">vignette
2</a>.</p>
<p>One of the individual covariates we want to include is size. At the
moment, most individuals below 10 mm are assigned a character string
<code>"&lt;10"</code>. This can be dealt with in two ways. Either having
them all a numeric value assigned, that can be a random value drawn from
a uniform distribution between 8 and 10 mm (or a fixed value) or them
being removed from the analyses (and analysed separately), having only
large sized individuals.</p>
<p>We will try here both approaches and see how different the results
are.</p>
<div class="section level3">
<h3 id="joint-sizes">Joint sizes<a class="anchor" aria-label="anchor" href="#joint-sizes"></a>
</h3>
<p>Here, we will assign a set value (9 mm) to each fish whose size is
below 10 mm.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># here I define the set value</span></span>
<span><span class="va">set_val</span> <span class="op">&lt;-</span> <span class="fl">9</span></span>
<span></span>
<span><span class="co"># all individuals below 10 mm (either measured or with a label "&lt;10")</span></span>
<span><span class="co"># will be assigned the set value</span></span>
<span><span class="va">dj</span> <span class="op">&lt;-</span> <span class="va">hab_sel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html" class="external-link">replace</a></span><span class="op">(</span><span class="va">SL</span>, <span class="va">SL</span> <span class="op">==</span> <span class="st">"&lt;10"</span>, <span class="va">set_val</span><span class="op">)</span>,</span>
<span>         SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span>,</span>
<span>         SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html" class="external-link">replace</a></span><span class="op">(</span><span class="va">SL</span>, <span class="va">SL</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="va">set_val</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can use the function <code><a href="https://rdrr.io/pkg/mlogit/man/mlogit-deprecated.html" class="external-link">mlogit.data()</a></code> to transform the
data in the appropriate format.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mld_dj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit-deprecated.html" class="external-link">mlogit.data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">dj</span><span class="op">)</span>, </span>
<span>                      shape <span class="op">=</span> <span class="st">"long"</span>, </span>
<span>                      alt.var <span class="op">=</span> <span class="st">"alt"</span>, </span>
<span>                      chid.var <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code></pre></div>
<p>The model does not work with <code>tibble</code>s, since it requires
rownames. From now on we need to work with <code>data.frame</code>s
instead of <code>tibble</code>s.</p>
<p>We can now run the model, making sure to use the right formula.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DCM_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit.html" class="external-link">mlogit</a></span><span class="op">(</span><span class="va">choice</span> <span class="op">~</span> <span class="va">ba</span> <span class="op">|</span> <span class="va">SL</span> <span class="op">*</span> <span class="va">sex_stage</span>, <span class="va">mld_dj</span>, reflevel <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">DCM_j</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## mlogit(formula = choice ~ ba | SL * sex_stage, data = mld_dj, </span></span>
<span><span class="co">##     reflevel = "A", method = "nr")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Frequencies of alternatives:choice</span></span>
<span><span class="co">##        A        B        C        D        E </span></span>
<span><span class="co">## 0.127700 0.169953 0.434742 0.218779 0.048826 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## nr method</span></span>
<span><span class="co">## 6 iterations, 0h:0m:0s </span></span>
<span><span class="co">## g'(-H)^-1g = 2.74E-07 </span></span>
<span><span class="co">## gradient close to zero </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients :</span></span>
<span><span class="co">##                Estimate Std. Error z-value  Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept):B  3.041746   1.046394  2.9069 0.0036505 ** </span></span>
<span><span class="co">## (Intercept):C  2.522669   0.787098  3.2050 0.0013505 ** </span></span>
<span><span class="co">## (Intercept):D  6.613799   1.910017  3.4627 0.0005348 ***</span></span>
<span><span class="co">## (Intercept):E  6.653669   1.710734  3.8894 0.0001005 ***</span></span>
<span><span class="co">## ba             2.344074   0.307263  7.6289 2.376e-14 ***</span></span>
<span><span class="co">## SL:B          -0.161337   0.048576 -3.3213 0.0008959 ***</span></span>
<span><span class="co">## SL:C          -0.096595   0.035123 -2.7502 0.0059555 ** </span></span>
<span><span class="co">## SL:D          -0.393126   0.103678 -3.7918 0.0001496 ***</span></span>
<span><span class="co">## SL:E          -0.368928   0.088777 -4.1557 3.244e-05 ***</span></span>
<span><span class="co">## sex_stageI:B   3.751584   1.502302  2.4972 0.0125170 *  </span></span>
<span><span class="co">## sex_stageI:C   2.686685   1.279408  2.0999 0.0357339 *  </span></span>
<span><span class="co">## sex_stageI:D   4.555692   2.225219  2.0473 0.0406286 *  </span></span>
<span><span class="co">## sex_stageI:E  -2.368749   2.138873 -1.1075 0.2680884    </span></span>
<span><span class="co">## sex_stageM:B   2.377612   4.114288  0.5779 0.5633374    </span></span>
<span><span class="co">## sex_stageM:C  -0.580063   3.577356 -0.1621 0.8711889    </span></span>
<span><span class="co">## sex_stageM:D  12.206176   7.618334  1.6022 0.1091090    </span></span>
<span><span class="co">## sex_stageM:E  -2.615696   8.124831 -0.3219 0.7474993    </span></span>
<span><span class="co">## SL:B          -0.247052   0.091056 -2.7132 0.0066640 ** </span></span>
<span><span class="co">## SL:C          -0.155226   0.076621 -2.0259 0.0427754 *  </span></span>
<span><span class="co">## SL:D          -0.321752   0.134643 -2.3897 0.0168637 *  </span></span>
<span><span class="co">## SL:E           0.097280   0.128986  0.7542 0.4507336    </span></span>
<span><span class="co">## SL:B          -0.132702   0.231284 -0.5738 0.5661292    </span></span>
<span><span class="co">## SL:C           0.040154   0.199876  0.2009 0.8407801    </span></span>
<span><span class="co">## SL:D          -0.740907   0.457738 -1.6186 0.1055276    </span></span>
<span><span class="co">## SL:E           0.080319   0.470366  0.1708 0.8644133    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Log-Likelihood: -1099.5</span></span>
<span><span class="co">## McFadden R^2:  0.26578 </span></span>
<span><span class="co">## Likelihood ratio test : chisq = 795.98 (p.value = &lt; 2.22e-16)</span></span></code></pre>
<p>The interpretation of the sign of the estimate for choice-specific
variables (here <code>SL</code> and <code>sex_stage</code>) is
non-intuitive, since it refers to the estimate compared to the other
levels. What can be interpreted is the estimated coefficient of
alternative-specific variables (<code>ba</code>)</p>
<p>The interesting effect seem to be between habitats. They are occupied
with significantly different probabilities by females, and there are no
significant differences between females and the other two classes (trend
safe for the occupancy of the C habitat by immature individuals). Size
also seems to have a significant effect on habitat occupancy. Benthic
area has also a significant positive effect (which can be interpreted,
given it’s alternative specific).</p>
<p>It’s good to keep in mind what the reference level and the Intercept
are. The intercept refers to females (<code>F</code>) of size 0. The
reference level for the dependent variable is habitat <code>A</code>. So
all odd-ratios in the intercept refer to the odd ratio between the
probability to be in a given habitat and the probability to be in A.</p>
<p>The function <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> makes it extremely easy to
calculate the predicted probabilities, for each row in the data, to be
in each of the habitats, given the model parameters.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">DCM_j</span>, <span class="st">"probabilities"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           A         B         C          D E</span></span>
<span><span class="co">## 1 0.1963599 0.1757113 0.5962863 0.03164248 0</span></span>
<span><span class="co">## 2 0.1836065 0.1830545 0.5948358 0.03850318 0</span></span>
<span><span class="co">## 3 0.1272047 0.2139024 0.5635508 0.09534219 0</span></span>
<span><span class="co">## 4 0.1270676 0.2125648 0.6241061 0.03626144 0</span></span>
<span><span class="co">## 5 0.1545004 0.1997245 0.5847627 0.06101233 0</span></span>
<span><span class="co">## 6 0.1016444 0.2234131 0.5286300 0.14631251 0</span></span></code></pre>
<p>It’s encouraging to see that the predicted probability to occupy “E”,
when this is not available, is zero.</p>
<p>Generating a mock dataset it’s possible to display the average
probabilities to occupy different habitats based on size and sex. The
mock dataset should be similar to the real data in its format.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mld_dj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ~~~~~~~</span></span>
<span><span class="co">##  first 10 observations out of 4366 </span></span>
<span><span class="co">## ~~~~~~~</span></span>
<span><span class="co">##    id markID alt choice    SL sex_stage        ba idx</span></span>
<span><span class="co">## 1   1   5B6O   A      0 21.29         F 0.1585938 1:A</span></span>
<span><span class="co">## 2   1   5B6O   B      0 21.29         F 0.2789063 1:B</span></span>
<span><span class="co">## 3   1   5B6O   C      0 21.29         F 0.4335938 1:C</span></span>
<span><span class="co">## 4   1   5B6O   D      1 21.29         F 0.1289062 1:D</span></span>
<span><span class="co">## 5   2   6W7K   A      0 20.62         F 0.1585938 2:A</span></span>
<span><span class="co">## 6   2   6W7K   B      0 20.62         F 0.2789063 2:B</span></span>
<span><span class="co">## 7   2   6W7K   C      0 20.62         F 0.4335938 2:C</span></span>
<span><span class="co">## 8   2   6W7K   D      1 20.62         F 0.1289062 2:D</span></span>
<span><span class="co">## 9   3   6G7K   A      0 17.38         F 0.1585938 3:A</span></span>
<span><span class="co">## 10  3   6G7K   B      0 17.38         F 0.2789063 3:B</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ~~~ indexes ~~~~</span></span>
<span><span class="co">##    chid alt</span></span>
<span><span class="co">## 1     1   A</span></span>
<span><span class="co">## 2     1   B</span></span>
<span><span class="co">## 3     1   C</span></span>
<span><span class="co">## 4     1   D</span></span>
<span><span class="co">## 5     2   A</span></span>
<span><span class="co">## 6     2   B</span></span>
<span><span class="co">## 7     2   C</span></span>
<span><span class="co">## 8     2   D</span></span>
<span><span class="co">## 9     3   A</span></span>
<span><span class="co">## 10    3   B</span></span>
<span><span class="co">## indexes:  1, 2</span></span></code></pre>
<p>First, we are creating the changing variables.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># vector of lengths</span></span>
<span><span class="va">sls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">mld_dj</span><span class="op">$</span><span class="va">SL</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">mld_dj</span><span class="op">$</span><span class="va">SL</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="co"># vector of sex_stages</span></span>
<span><span class="va">sxs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mld_dj</span><span class="op">$</span><span class="va">sex_stage</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># then using expand.grid I can create all combinations. </span></span>
<span><span class="co"># Each of them is a hypothetical individual, so it whould receive an id</span></span>
<span><span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>SL <span class="op">=</span> <span class="va">sls</span>, sex_stage <span class="op">=</span> <span class="va">sxs</span><span class="op">)</span>, </span>
<span>               id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sls</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sxs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now each individual should be repeated as many times as the available
habitats, and each of the habitats should be assigned an
alternative-specific variable, if there are. In our case, we do have the
relative benthic area. Here, to make the interpretation of the figures
easier, we will assume all habitats are present with equal proportions
(0.20).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">habs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>alt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">mld_dj</span><span class="op">$</span><span class="va">alt</span><span class="op">)</span>, </span>
<span>                                na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>                   ba <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now I can "expand grid" again (this time using merge, since I am combining dataframes)</span></span>
<span><span class="va">mock_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">habs</span>, <span class="va">block</span>, by <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># habitat alternatives should be turned into factors</span></span>
<span><span class="va">mock_d</span><span class="op">$</span><span class="va">alt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">mock_d</span><span class="op">$</span><span class="va">alt</span><span class="op">)</span></span></code></pre></div>
<p>Now we have what we need to predict…</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generating predictions and storing them side by side with the block</span></span>
<span><span class="co"># (which unlike mock_d does not have repeated individuals once per habitat)</span></span>
<span><span class="va">pred_mock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">block</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_j</span>, newdata <span class="op">=</span> <span class="va">mock_d</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span>           </span>
<span></span>
<span><span class="co"># I don't want to show prediction for irrational values (e.g. very</span></span>
<span><span class="co"># large immature individuals, which are not present, or very small mature ones)</span></span>
<span><span class="co"># I'll limit the plotting to reasonable values</span></span>
<span><span class="co"># here I'll find the ranges for female, males and immature individuals</span></span>
<span><span class="va">low_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"M"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: NAs introduced by coercion</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">low_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"F"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">hi_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"M"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: NAs introduced by coercion</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hi_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: NAs introduced by coercion</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_mock</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"I"</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&lt;</span> <span class="va">hi_i</span> <span class="op">|</span></span>
<span>           <span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"F"</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&gt;</span> <span class="va">low_f</span> <span class="op">|</span></span>
<span>           <span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"M"</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&gt;</span> <span class="va">low_m</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&lt;</span> <span class="va">hi_m</span><span class="op">)</span></span>
<span>     </span>
<span></span>
<span><span class="co"># reshaping dataset to long(er) format, and releveling sex_stage</span></span>
<span><span class="va">pred_mock</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span>, key <span class="op">=</span> <span class="va">habitat</span>, value <span class="op">=</span> <span class="va">probability</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex_stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sex_stage</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"I"</span>, <span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>…and we can plot. When plotting, we’ll make sure to trim the
predictions to the measured values of size in the
<code>sex_stages</code>, so we won’t infer non-realistic
probabilities.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plotting</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_mock</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">SL</span>, y <span class="op">=</span> <span class="va">probability</span>, colour <span class="op">=</span> <span class="va">sex_stage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#1E88E5"</span>, <span class="st">"#FFC107"</span>, <span class="st">"#004D40"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free"</span>, labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html" class="external-link">labeller</a></span><span class="op">(</span>habitat <span class="op">=</span> <span class="fu">hablab</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Joint size model - predictions"</span><span class="op">)</span></span></code></pre></div>
<p><img src="DME-030_Habitat_use_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="split-sizes">Split sizes<a class="anchor" aria-label="anchor" href="#split-sizes"></a>
</h3>
<p>We will now repeat the same analyses, but using a split size
approach. Here we will run a model for individuals larger than 10 mm,
and a model (size-independent) for individuals below that threshold
value.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for now I will only take individuals with a numeric size</span></span>
<span><span class="co"># creating a dataset for adults (&gt; 10mm, with size information)</span></span>
<span><span class="va">ds_ads</span> <span class="op">&lt;-</span> <span class="va">hab_sel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SL</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There was 1 warning in `mutate()`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> In argument: `SL = as.numeric(SL)`.</span></span>
<span><span class="co">## Caused by warning:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> NAs introduced by coercion</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># and a dataset for babies, &lt;10mm, and without precise SL measurements</span></span>
<span><span class="va">ds_bbs</span> <span class="op">&lt;-</span> <span class="va">hab_sel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SL</span> <span class="op">==</span> <span class="st">"&lt;10"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span><span class="op">&lt;</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There was 1 warning in `filter()`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> In argument: `SL == "&lt;10" | as.numeric(SL) &lt; 10`.</span></span>
<span><span class="co">## Caused by warning:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> NAs introduced by coercion</span></span></code></pre>
<p>We are working here with two datasets. First, the adults
regressions.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># converting dataset into mlogit format</span></span>
<span><span class="va">mld_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit-deprecated.html" class="external-link">mlogit.data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ds_ads</span><span class="op">)</span>, </span>
<span>                       shape <span class="op">=</span> <span class="st">"long"</span>,</span>
<span>                       alt.var <span class="op">=</span> <span class="st">"alt"</span>,</span>
<span>                       chid.var <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># running model</span></span>
<span><span class="va">DCM_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit.html" class="external-link">mlogit</a></span><span class="op">(</span><span class="va">choice</span> <span class="op">~</span> <span class="va">ba</span> <span class="op">|</span> <span class="va">SL</span> <span class="op">*</span> <span class="va">sex_stage</span>, <span class="va">mld_ads</span>, reflevel <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualizing results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">DCM_ads</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## mlogit(formula = choice ~ ba | SL * sex_stage, data = mld_ads, </span></span>
<span><span class="co">##     reflevel = "A", method = "nr")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Frequencies of alternatives:choice</span></span>
<span><span class="co">##        A        B        C        D        E </span></span>
<span><span class="co">## 0.173971 0.163347 0.501992 0.104914 0.055777 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## nr method</span></span>
<span><span class="co">## 6 iterations, 0h:0m:0s </span></span>
<span><span class="co">## g'(-H)^-1g = 0.000139 </span></span>
<span><span class="co">## successive function values within tolerance limits </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients :</span></span>
<span><span class="co">##                 Estimate Std. Error z-value  Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept):B  2.9255178  1.0463262  2.7960 0.0051741 ** </span></span>
<span><span class="co">## (Intercept):C  2.5015990  0.7795960  3.2088 0.0013327 ** </span></span>
<span><span class="co">## (Intercept):D  6.5548691  1.9087396  3.4341 0.0005944 ***</span></span>
<span><span class="co">## (Intercept):E  6.7215712  1.7023475  3.9484 7.867e-05 ***</span></span>
<span><span class="co">## ba             1.8224748  0.3457420  5.2712 1.355e-07 ***</span></span>
<span><span class="co">## SL:B          -0.1572519  0.0485833 -3.2367 0.0012090 ** </span></span>
<span><span class="co">## SL:C          -0.0922041  0.0348057 -2.6491 0.0080704 ** </span></span>
<span><span class="co">## SL:D          -0.3914744  0.1036319 -3.7775 0.0001584 ***</span></span>
<span><span class="co">## SL:E          -0.3694206  0.0883616 -4.1808 2.905e-05 ***</span></span>
<span><span class="co">## sex_stageI:B   6.2723055  2.1447820  2.9244 0.0034507 ** </span></span>
<span><span class="co">## sex_stageI:C   4.6461756  1.8366831  2.5297 0.0114175 *  </span></span>
<span><span class="co">## sex_stageI:D   6.3184530  2.8229254  2.2383 0.0252038 *  </span></span>
<span><span class="co">## sex_stageI:E  -0.6554867  2.7615549 -0.2374 0.8123764    </span></span>
<span><span class="co">## sex_stageM:B   2.9088381  4.0900103  0.7112 0.4769569    </span></span>
<span><span class="co">## sex_stageM:C  -0.0832127  3.5448107 -0.0235 0.9812718    </span></span>
<span><span class="co">## sex_stageM:D  12.8493884  7.5828446  1.6945 0.0901638 .  </span></span>
<span><span class="co">## sex_stageM:E  -2.0030492  8.1144747 -0.2468 0.8050252    </span></span>
<span><span class="co">## SL:B          -0.4026189  0.1321971 -3.0456 0.0023222 ** </span></span>
<span><span class="co">## SL:C          -0.2718278  0.1090607 -2.4924 0.0126867 *  </span></span>
<span><span class="co">## SL:D          -0.4238873  0.1774203 -2.3892 0.0168865 *  </span></span>
<span><span class="co">## SL:E          -0.0056157  0.1694523 -0.0331 0.9735627    </span></span>
<span><span class="co">## SL:B          -0.1628600  0.2298388 -0.7086 0.4785829    </span></span>
<span><span class="co">## SL:C           0.0115024  0.1979583  0.0581 0.9536647    </span></span>
<span><span class="co">## SL:D          -0.7793494  0.4555359 -1.7108 0.0871105 .  </span></span>
<span><span class="co">## SL:E           0.0432260  0.4697855  0.0920 0.9266884    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Log-Likelihood: -829.03</span></span>
<span><span class="co">## McFadden R^2:  0.18065 </span></span>
<span><span class="co">## Likelihood ratio test : chisq = 365.56 (p.value = &lt; 2.22e-16)</span></span></code></pre>
<p>The results for adults only are very similar to those obtained for
all individuals in the “Joint size” model.</p>
<p>We can now repeat the same analyses, with the individuals
<strong>&lt; 10 mm</strong>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mld_bbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit-deprecated.html" class="external-link">mlogit.data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ds_bbs</span><span class="op">)</span>,</span>
<span>                       shape <span class="op">=</span> <span class="st">"long"</span>, </span>
<span>                       alt.var <span class="op">=</span> <span class="st">"alt"</span>, </span>
<span>                       chid.var <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># running model</span></span>
<span><span class="va">DCM_bbs</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit.html" class="external-link">mlogit</a></span><span class="op">(</span><span class="va">choice</span> <span class="op">~</span> <span class="va">ba</span> <span class="op">|</span> <span class="fl">1</span>, <span class="va">mld_bbs</span>, reflevel <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span>
<span><span class="co"># visualizing results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">DCM_bbs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## mlogit(formula = choice ~ ba | 1, data = mld_bbs, reflevel = "A", </span></span>
<span><span class="co">##     method = "nr")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Frequencies of alternatives:choice</span></span>
<span><span class="co">##        A        B        C        D        E </span></span>
<span><span class="co">## 0.016026 0.185897 0.272436 0.493590 0.032051 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## nr method</span></span>
<span><span class="co">## 6 iterations, 0h:0m:0s </span></span>
<span><span class="co">## g'(-H)^-1g = 1.44E-07 </span></span>
<span><span class="co">## gradient close to zero </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients :</span></span>
<span><span class="co">##               Estimate Std. Error z-value  Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept):B  2.65913    0.47181  5.6360 1.741e-08 ***</span></span>
<span><span class="co">## (Intercept):C  2.10509    0.47361  4.4448 8.797e-06 ***</span></span>
<span><span class="co">## (Intercept):D  4.39983    0.47246  9.3126 &lt; 2.2e-16 ***</span></span>
<span><span class="co">## (Intercept):E  1.33148    0.55660  2.3922   0.01675 *  </span></span>
<span><span class="co">## ba             4.50326    0.74174  6.0712 1.270e-09 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Log-Likelihood: -262.95</span></span>
<span><span class="co">## McFadden R^2:  0.293 </span></span>
<span><span class="co">## Likelihood ratio test : chisq = 217.94 (p.value = &lt; 2.22e-16)</span></span></code></pre>
<p>Below is a combined plot for the split sizes.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># predictions for adults</span></span>
<span><span class="va">sls_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">mld_ads</span><span class="op">$</span><span class="va">SL</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">mld_ads</span><span class="op">$</span><span class="va">SL</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">sxs_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mld_ads</span><span class="op">$</span><span class="va">sex_stage</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">block_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>SL <span class="op">=</span> <span class="va">sls_ads</span>, sex_stage <span class="op">=</span> <span class="va">sxs_ads</span><span class="op">)</span>, </span>
<span>               id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sls_ads</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sxs_ads</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">habs_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>alt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">mld_ads</span><span class="op">$</span><span class="va">alt</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>              ba <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span><span class="va">mock_ads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">habs_ads</span>, <span class="va">block</span>, by <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># predictions for adults</span></span>
<span><span class="va">pred_mock_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">block_ads</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_ads</span>, newdata <span class="op">=</span> <span class="va">mock_ads</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span></span>
<span><span class="co"># as done for the joint model, triming sex_stage to actual size range</span></span>
<span><span class="va">pred_mock_s</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"I"</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&lt;</span> <span class="va">hi_i</span> <span class="op">|</span></span>
<span>           <span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"F"</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&gt;</span> <span class="va">low_f</span> <span class="op">|</span></span>
<span>           <span class="va">sex_stage</span> <span class="op">==</span> <span class="st">"M"</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&gt;</span> <span class="va">low_m</span> <span class="op">&amp;</span> <span class="va">SL</span> <span class="op">&lt;</span> <span class="va">hi_m</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reshaping dataset</span></span>
<span><span class="va">pred_mock_s</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span>, key <span class="op">=</span> <span class="va">habitat</span>, value <span class="op">=</span> <span class="va">probability</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># creating a separate predictions for babies and combining the two datasets</span></span>
<span><span class="va">pred_mock_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>probability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_bbs</span>,</span>
<span>                                                      newdata <span class="op">=</span> <span class="va">habs</span>,</span>
<span>                                                      type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span>,</span>
<span>                                habitat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_bbs</span>,</span>
<span>                                                      newdata <span class="op">=</span> <span class="va">habs</span>,</span>
<span>                                                      type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">10</span><span class="op">)</span>, sex_stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"&lt; 10mm"</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pred_mock_s</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reordering factors for sex_stage</span></span>
<span><span class="va">pred_mock_s</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex_stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sex_stage</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt; 10mm"</span>, <span class="st">"I"</span>, <span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plotting</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_mock_s</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">SL</span>, y <span class="op">=</span> <span class="va">probability</span>, colour <span class="op">=</span> <span class="va">sex_stage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"#1E88E5"</span>, <span class="st">"#FFC107"</span>, <span class="st">"#004D40"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free"</span>, labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html" class="external-link">labeller</a></span><span class="op">(</span>habitat <span class="op">=</span> <span class="fu">hablab</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Split-size Model"</span><span class="op">)</span></span></code></pre></div>
<p><img src="DME-030_Habitat_use_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="simulations-of-occupancy">Simulations of Occupancy<a class="anchor" aria-label="anchor" href="#simulations-of-occupancy"></a>
</h2>
<p>Now that we have generated models from the capture data we can use
them, together with the census data from the recapture, to generate
predicted occupancy. If density has not affected habitat use, the
predicted occupancy should match the observed one. If it has, the only
matching observation would be for the control pool, whereas the observed
occupancy in increased and decreased pool will not match the predicted
one.</p>
<p>To generate the simulations, for simplicity, we will only use the
joint model since it quite closely matches the split one.</p>
<p>First, we extract the data for the recapture.</p>
<p>The <code>predict</code> function in mlogit turns out to be rather
clunky and confusing. We are trying here to follow the direction of user
“Manos C” from <a href="https://stats.stackexchange.com/questions/6702/predict-after-running-the-mlogit-function-in-r/60778" class="external-link">this
thread</a> to make it work. If not, we will then adopt the trick
suggested by user “Robert Bray”.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># I will here add information on the pool treatment,</span></span>
<span><span class="co"># filter out the capture event info and transform SL "&lt;10"</span></span>
<span><span class="co"># values into the set_value</span></span>
<span><span class="va">recap_data</span> <span class="op">&lt;-</span> <span class="va">treatment_tab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pool_treatment <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace_all</a></span><span class="op">(</span><span class="va">treatment</span>,</span>
<span>                                          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"I"</span> <span class="op">=</span> <span class="st">"increased"</span>,</span>
<span>                                            <span class="st">"C"</span> <span class="op">=</span> <span class="st">"control"</span>,</span>
<span>                                            <span class="st">"D"</span> <span class="op">=</span> <span class="st">"decreased"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">streamID</span>, <span class="va">patchID</span>, <span class="va">pool_treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">recap</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>                             <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">habitat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html" class="external-link">replace</a></span><span class="op">(</span><span class="va">SL</span>, <span class="va">SL</span> <span class="op">==</span> <span class="st">"&lt;10"</span>, <span class="va">set_val</span><span class="op">)</span>,</span>
<span>         SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">SL</span><span class="op">)</span>,</span>
<span>         SL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html" class="external-link">replace</a></span><span class="op">(</span><span class="va">SL</span>, <span class="va">SL</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="va">set_val</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pool_treatment</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sex_stage</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Joining with `by = join_by(streamID, patchID)`</span></span></code></pre>
<pre><code><span><span class="co">## Warning: There was 1 warning in `mutate()`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> In argument: `SL = as.numeric(SL)`.</span></span>
<span><span class="co">## Caused by warning:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> NAs introduced by coercion</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filtering out the NAs for sex_stage is extremely important.</span></span>
<span><span class="co"># see https://stats.stackexchange.com/questions/6702/predict-after-running-the-mlogit-function-in-r</span></span>
<span></span>
<span><span class="co"># now I can select the columns I need for the predictions</span></span>
<span><span class="co"># I am keeping the habitat to generate a fake choice column later</span></span>
<span><span class="va">to_predict</span> <span class="op">&lt;-</span> <span class="va">recap_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">streamID</span>, <span class="va">patchID</span>, <span class="va">markID</span>, <span class="va">SL</span>, <span class="va">sex_stage</span>, <span class="va">habitat</span>, <span class="va">pool_treatment</span>,</span>
<span>         <span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html" class="external-link">add_column</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extracting only individual info (dropping habitat area)</span></span>
<span><span class="va">block_predict</span> <span class="op">&lt;-</span> <span class="va">to_predict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">streamID</span>, <span class="va">patchID</span>, <span class="va">markID</span>, <span class="va">SL</span>, <span class="va">sex_stage</span>, <span class="va">habitat</span>, <span class="va">pool_treatment</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and finally reshape is as a long format</span></span>
<span><span class="co"># also, releveling the factors to match those above and creating mock choice</span></span>
<span><span class="va">ml_topred</span> <span class="op">&lt;-</span> <span class="va">to_predict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span>, key <span class="op">=</span> <span class="st">"alt"</span>, value <span class="op">=</span> <span class="st">"ba"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>alt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">alt</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">mock_d</span><span class="op">$</span><span class="va">alt</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         sex_stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sex_stage</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">mock_d</span><span class="op">$</span><span class="va">sex_stage</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         choice <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="va">alt</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">alt</span>, <span class="va">ba</span>, <span class="va">SL</span>, <span class="va">sex_stage</span>, <span class="va">choice</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ba</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>chid <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span><span class="co"># the step of filtering out the choices where ba = 0 (non-existing</span></span>
<span><span class="co"># alternatives) is crucial since it allows to predict a probability</span></span>
<span><span class="co"># equal to zero to choose that habitat!</span></span>
<span></span>
<span><span class="co"># I need to run the function `mlogit.data` (according to Manos C),</span></span>
<span><span class="co"># as if this data needed to be anlysed</span></span>
<span><span class="va">ml_topred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlogit/man/mlogit-deprecated.html" class="external-link">mlogit.data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ml_topred</span><span class="op">)</span>, shape <span class="op">=</span> <span class="st">"long"</span>, </span>
<span>                      alt.var <span class="op">=</span> <span class="st">"alt"</span>, chid.var <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code></pre></div>
<p>We can now extract the predicted probabilities for each individual to
be in one of the habitats in a given pool, based on their size, sex and
the habitat availability during recapture.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># before storing the model anywhere, I am making some quick tests</span></span>
<span><span class="co"># whether the predict works out well.</span></span>
<span><span class="co"># The number of predictions should be equal to the number of individuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">block_predict</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_j</span>, newdata <span class="op">=</span> <span class="va">ml_topred</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># also, the predict should be unaffected by the arbitrary choice I introduced</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_j</span>, newdata <span class="op">=</span> <span class="va">ml_topred</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="va">ml_topred2</span> <span class="op">&lt;-</span> <span class="va">ml_topred</span></span>
<span><span class="va">ml_topred2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="st">"choice"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_j</span>, newdata <span class="op">=</span> <span class="va">ml_topred2</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># all good, we can store the predictions</span></span>
<span></span>
<span><span class="va">recap_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">block_predict</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">DCM_j</span>, newdata <span class="op">=</span> <span class="va">ml_topred</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="comparing-simulations-to-observed-occupancy">Comparing simulations to observed occupancy<a class="anchor" aria-label="anchor" href="#comparing-simulations-to-observed-occupancy"></a>
</h3>
<p>Now that we generated the predicted probabilities of each individual
to be in a given habitat given its size, sex and habitat availability,
we can generate simulations of occupancy for each pool and compare the
reference value with the real observed occupancy.</p>
<p>Before running any simulation, we can plot the observed occupancy
with the sum of probabilities for individuals to be in each habitat
(summing individual probability distributions among habitats).</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># gathering predicted distributions</span></span>
<span><span class="va">pred_distr</span> <span class="op">&lt;-</span> <span class="va">recap_preds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">streamID</span>, <span class="va">pool_treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>,</span>
<span>            B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span>,</span>
<span>            C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span>,</span>
<span>            D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span>,</span>
<span>            E <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span>, key <span class="op">=</span> <span class="va">habitat</span>, value <span class="op">=</span> <span class="va">predicted</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `summarise()` has grouped output by 'streamID'. You can override using the</span></span>
<span><span class="co">## `.groups` argument.</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now observed distributions</span></span>
<span><span class="va">obs_distr</span> <span class="op">&lt;-</span> <span class="va">recap_preds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">streamID</span>, <span class="va">pool_treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span>,</span>
<span>            B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">)</span>,</span>
<span>            C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="st">"C"</span><span class="op">)</span>,</span>
<span>            D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="st">"D"</span><span class="op">)</span>,</span>
<span>            E <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">habitat</span> <span class="op">==</span> <span class="st">"E"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">C</span>, <span class="va">D</span>, <span class="va">E</span>, key <span class="op">=</span> <span class="va">habitat</span>, value <span class="op">=</span> <span class="va">observed</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `summarise()` has grouped output by 'streamID'. You can override using the</span></span>
<span><span class="co">## `.groups` argument.</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now joining the two</span></span>
<span><span class="va">pred_v_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">pred_distr</span>, <span class="va">obs_distr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Joining with `by = join_by(streamID, pool_treatment, habitat)`</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># and plotting</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_v_obs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">habitat</span>, col <span class="op">=</span> <span class="va">habitat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">predicted</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">streamID</span> <span class="op">~</span> <span class="va">pool_treatment</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"#ffd700"</span>,</span>
<span>  <span class="st">"#fa8775"</span>,</span>
<span>  <span class="st">"#cd34b5"</span>,</span>
<span>  <span class="st">"#9d02d7"</span>,</span>
<span>  <span class="st">"#0000ff"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="DME-030_Habitat_use_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>The filled circles here represent the observed occupancy, while the
empty diamonds represent predicted occupancy.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Seba De Bona, Matthieu Bruneaux, Andrés López-Sepulcre.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
